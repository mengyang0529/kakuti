[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
loglevel=info

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# Backend FastAPI application
[program:backend]
command=python -m uvicorn app.main:app --host 127.0.0.1 --port 8001
directory=/app/backend
user=app
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/backend.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
environment=
    PYTHONUNBUFFERED=1,
    DB_TYPE=sqlite,
    DOCMIND_DB=/app/backend/storage/docmind.db,
    LLM_PROVIDER=gemini,
    REQUIRE_API_KEY=%(ENV_REQUIRE_API_KEY)s,
    API_KEY=%(ENV_API_KEY)s,
    GEMINI_API_KEY=%(ENV_GEMINI_API_KEY)s,
    GOOGLE_API_KEY=%(ENV_GOOGLE_API_KEY)s,
    GEMINI_REQUEST_TIMEOUT=30,
    RAG_TOP_K=6,
    RAG_MAX_CONTEXT_TOKENS=1800,
    RAG_BLOCK_MAX_TOKENS=800,
    RAG_BLOCK_TARGET_TOKENS=400,
    RAG_BLOCK_OVERLAP_TOKENS=80,
    RAG_MMR_LAMBDA=0.5,
    RAG_SIMILARITY_THRESHOLD=0.65,
    RAG_EMBEDDING_MODEL=text-embedding-004,
    RAG_GENERATION_MODEL=gemini-1.5-flash,
    HF_HOME=/tmp,
    RATE_LIMIT_PER_MINUTE=120,
    RATE_LIMIT_BURST=60

# Nginx reverse proxy
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/nginx.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
depends_on=backend
